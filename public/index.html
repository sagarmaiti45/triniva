<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triniva AI</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/payment-modal.css">
</head>
<body>
    <!-- Cookie Consent Banner -->
    <div class="cookie-consent" id="cookieConsent">
        <div class="cookie-content">
            <div class="cookie-text">
                <i class="fas fa-cookie-bite"></i>
                <p>We use cookies to enhance your experience. By continuing to use our site, you agree to our <a href="/privacy-policy" target="_blank">Privacy Policy</a> and cookie usage.</p>
            </div>
            <div class="cookie-buttons">
                <button class="cookie-btn cookie-accept" id="cookieAccept">Accept</button>
                <button class="cookie-btn cookie-reject" id="cookieReject">Decline</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" title="New chat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span class="btn-text">New chat</span>
                </button>
                <button class="sidebar-collapse-btn desktop-only" id="sidebarToggle" title="Toggle sidebar">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button class="sidebar-close-btn mobile-only" id="sidebarCloseMobile" title="Close sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="conversations-list" id="conversationsList">
                <!-- Recent conversations will be loaded here -->
                <div class="no-conversations" id="noConversations" title="Start a new chat to begin">
                    <i class="fas fa-comments"></i>
                    <p>Start a new chat to begin</p>
                </div>
                <!-- Chat history container -->
                <div class="chat-history-container" id="chatHistoryContainer" style="display: none;">
                    <div class="chat-history-header">
                        <span>Recent Chats</span>
                        <span class="chat-limit" id="chatLimitText"></span>
                    </div>
                    <div class="recent-chats" id="recentChats">
                        <!-- Individual chat items will be added here -->
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <a href="/dashboard" style="text-decoration: none;">
                    <button class="user-account-btn" title="My Account">
                        <i class="fas fa-user-circle"></i>
                        <span class="btn-text">My Account</span>
                    </button>
                </a>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-content">
            <!-- Main Header Bar -->
            <div class="main-header">
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <img src="/images/logo.png" alt="Menu" class="sidebar-logo-icon">
                </button>
                <div class="logo-container">
                    <img src="/images/logo.png" alt="Triniva AI" class="header-logo desktop-only">
                    <h1 class="logo-text">Triniva AI</h1>
                    <!-- Mobile user menu button (shows only on mobile when logged in) -->
                    <button class="mobile-user-menu-btn" id="mobileUserMenuBtn" style="display: none;">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <!-- Mobile user dropdown (duplicated for mobile positioning) -->
                    <div class="user-dropdown mobile-user-dropdown" id="mobileUserDropdown">
                        <a href="/dashboard" class="dropdown-item">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="/dashboard/billing.html" class="dropdown-item">
                            <i class="fas fa-credit-card"></i>
                            <span>Billing</span>
                        </a>
                        <a href="/dashboard/profile.html" class="dropdown-item">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                    </div>
                </div>
                <!-- Auth buttons for non-logged in users -->
                <div class="auth-buttons-container" id="authButtons" style="display: none;">
                    <a href="/auth/login" class="header-auth-btn login-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Login</span>
                    </a>
                    <a href="/auth/signup" class="header-auth-btn signup-btn">
                        <i class="fas fa-user-plus"></i>
                        <span>Sign Up</span>
                    </a>
                </div>
                <!-- Greeting for logged in users -->
                <div class="greeting-container" id="greetingContainer" style="display: none;">
                    <span id="greeting" class="greeting-text"></span>
                    <span class="user-name">User</span>
                    <button class="user-menu-btn" id="userMenuBtn">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="/dashboard" class="dropdown-item">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="/dashboard/billing.html" class="dropdown-item">
                            <i class="fas fa-credit-card"></i>
                            <span>Billing</span>
                        </a>
                        <a href="/dashboard/profile.html" class="dropdown-item">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Menu button positioned absolutely -->
            <button class="main-menu-button" id="mainMenuButton">
                <i class="fas fa-ellipsis-v desktop-only"></i>
                <div class="two-dots mobile-only">
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
            </button>
            
            <!-- 3-dot menu dropdown -->
            <div class="main-menu-dropdown" id="mainMenuDropdown">
                <!-- Login/Signup items for non-logged in users -->
                <a href="/auth/login" class="menu-item" id="loginMenuItem" style="display: none;">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Login</span>
                </a>
                <a href="/auth/signup" class="menu-item" id="signupMenuItem" style="display: none;">
                    <i class="fas fa-user-plus"></i>
                    <span>Sign Up</span>
                </a>
                <div class="menu-divider" id="authDivider" style="display: none;"></div>
                
                <!-- Share option (shown in chat view) -->
                <div class="menu-item" id="shareMenuItem" style="display: none;">
                    <i class="fas fa-share"></i>
                    <span>Share</span>
                </div>
                <div class="menu-divider" id="menuDivider" style="display: none;"></div>
                
                <!-- General menu items -->
                <a href="/plans" class="menu-item">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Pricing Plans</span>
                </a>
                <a href="/about-us" class="menu-item">
                    <i class="fas fa-info-circle"></i>
                    <span>About Us</span>
                </a>
                <a href="/contact-us" class="menu-item">
                    <i class="fas fa-envelope"></i>
                    <span>Contact Us</span>
                </a>
                
                <!-- Logout for logged in users -->
                <div class="menu-divider" id="logoutDivider" style="display: none;"></div>
                <div class="menu-item" id="logoutMenuItem" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
            
            <!-- Sidebar Overlay for Mobile -->
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            
            <div class="chat-area">
                <!-- Welcome/Hero View -->
                <div id="welcomeView" class="welcome-view" style="display: none;">
                    <div class="welcome-content">
                        <p class="welcome-subtitle" id="dynamicText">What's on your mind today?</p>
                        
                        <div class="hero-input-container">
                            <div class="attach-wrapper">
                                <button class="attach-button" id="heroAttachButton">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <div class="attach-menu" id="heroAttachMenu">
                                    <div class="attach-menu-item" data-action="image">
                                        <i class="fas fa-image"></i>
                                        <span>Upload Image</span>
                                    </div>
                                    <div class="attach-menu-item disabled" data-action="generate-image">
                                        <i class="fas fa-palette"></i>
                                        <span>Generate Image</span>
                                    </div>
                                    <div class="attach-menu-item disabled" data-action="generate-video">
                                        <i class="fas fa-video"></i>
                                        <span>Generate Video</span>
                                    </div>
                                </div>
                                <input type="file" id="heroImageInput" accept="image/*" style="display: none;" multiple>
                            </div>
                            <textarea 
                                id="heroMessageInput" 
                                class="hero-message-input" 
                                placeholder="Ask anything..."
                                rows="1"
                            ></textarea>
                            <button class="model-button-mobile" id="mobileModelButton" title="Select model">
                                <img src="/images/models/openai.png" alt="Model" class="mobile-model-logo">
                            </button>
                            <!-- Custom Model Dropdown -->
                            <div class="custom-model-dropdown" id="customModelDropdown">
                                <div class="custom-model-dropdown-trigger" id="modelDropdownTrigger">
                                    <img src="/images/models/openai.png" alt="Model" class="model-logo">
                                    <span class="model-name">GPT OSS 20B</span>
                                </div>
                                <div class="custom-model-dropdown-menu" id="modelDropdownMenu">
                                    <!-- Menu items will be generated by JavaScript -->
                                </div>
                            </div>
                            <!-- Keep original select hidden for form submission -->
                            <select id="modelSelect" class="model-selector-inline">
                                <option value="openai/gpt-oss-20b:free">GPT OSS 20B</option>
                                <option value="mistralai/mistral-medium">Mistral Medium</option>
                                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                                <option value="qwen/qwen3-coder">Qwen3 Coder</option>
                                <option value="moonshotai/kimi-k2:free">Kimi K2</option>
                                <option value="anthropic/claude-sonnet-4">Claude Sonnet 4</option>
                                <option value="openai/gpt-5-mini">GPT-5 Mini</option>
                                <option value="openai/gpt-5">GPT-5</option>
                                <option value="anthropic/claude-3.5-haiku">Claude 3.5 Haiku</option>
                                <option value="google/gemini-2.5-flash">Gemini 2.5 Flash</option>
                                <option value="x-ai/grok-4">Grok 4</option>
                                <option value="x-ai/grok-3-mini">Grok 3 Mini</option>
                                <option value="meta-llama/llama-4-maverick">Llama 4 Maverick</option>
                                <option value="meta-llama/llama-4-maverick:free">Llama 4 Maverick</option>
                                <option value="z-ai/glm-4.5">GLM 4.5</option>
                                <option value="deepseek/deepseek-r1-0528:free">DeepSeek R1</option>
                            </select>
                            <button class="mic-button" title="Voice input">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button id="heroSendButton" class="hero-send-button" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="image-preview-container" id="heroImagePreview"></div>
                    </div>
                    <p class="footer-hint">
                        <span class="footer-text-desktop">Triniva AI can make mistakes. Consider checking <a href="/important-info" class="important-info-link">important information</a>.</span>
                        <span class="footer-text-mobile">AI can make mistakes. Check <a href="/important-info" class="important-info-link">important info</a>.</span>
                    </p>
                </div>

                <!-- Chat Header (Outside container for proper fixed positioning) -->
                <div class="chat-header" id="chatHeader" style="display: none;">
                    <button class="share-button">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </button>
                </div>
                
                <!-- Chat View -->
                <div id="chatView" class="chat-view" style="display: none;">
                    <div id="messagesContainer" class="messages-container"></div>
                    
                    <div class="input-area">
                        <div class="input-container">
                            <div class="attach-wrapper">
                                <button class="attach-button" id="chatAttachButton">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <div class="attach-menu" id="chatAttachMenu">
                                    <div class="attach-menu-item" data-action="image">
                                        <i class="fas fa-image"></i>
                                        <span>Upload Image</span>
                                    </div>
                                    <div class="attach-menu-item disabled" data-action="generate-image">
                                        <i class="fas fa-palette"></i>
                                        <span>Generate Image</span>
                                    </div>
                                    <div class="attach-menu-item disabled" data-action="generate-video">
                                        <i class="fas fa-video"></i>
                                        <span>Generate Video</span>
                                    </div>
                                </div>
                                <input type="file" id="chatImageInput" accept="image/*" style="display: none;" multiple>
                            </div>
                            <textarea 
                                id="messageInput" 
                                class="message-input" 
                                placeholder="Ask anything..."
                                rows="1"
                            ></textarea>
                            <button class="mic-button" title="Voice input">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button id="sendButton" class="send-button" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="image-preview-container" id="chatImagePreview"></div>
                        <p class="input-hint">
                            <span class="footer-text-desktop">Triniva AI can make mistakes. Consider checking <a href="/important-info" class="important-info-link">important information</a>.</span>
                            <span class="footer-text-mobile">AI can make mistakes. Check <a href="/important-info" class="important-info-link">important info</a>.</span>
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
    
    <!-- Load Razorpay -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Load configuration -->
    <script src="/js/env-config.js"></script>
    <script src="/js/config.js"></script>

    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    
    <!-- Load payment and upgrade modules -->
    <script type="module">
        import { UpgradePrompt } from '/js/upgrade-prompt.js';
        import { PaymentModal } from '/js/payment-modal.js';
        import { ChatManager } from '/js/chat-manager.js';
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // Initialize Supabase and payment modal
        const supabaseUrl = localStorage.getItem('SUPABASE_URL');
        const supabaseAnonKey = localStorage.getItem('SUPABASE_ANON_KEY');
        let supabase = null;
        
        if (supabaseUrl && supabaseAnonKey) {
            supabase = createClient(supabaseUrl, supabaseAnonKey);
            window.supabase = supabase; // Make it globally available for logout
            window.paymentModal = new PaymentModal(supabase);
        }
        
        // Always initialize chat manager (with or without Supabase)
        // This allows guest users to have chat sessions
        window.chatManager = new ChatManager(supabase, window.chatApp || {});
        // Don't show skeleton here - it will be shown in initialize()
        
        // Initialize upgrade prompt
        window.upgradePrompt = new UpgradePrompt();
    </script>
    
    <!-- Set initial view based on URL before other scripts load -->
    <script>
        // Check if we're on a chat URL and set initial view accordingly
        (function() {
            const path = window.location.pathname;
            const welcomeView = document.getElementById('welcomeView');
            const chatView = document.getElementById('chatView');
            const chatHeader = document.getElementById('chatHeader');
            
            if (path === '/' || path === '') {
                // Homepage - show welcome view
                if (welcomeView) welcomeView.style.display = 'flex';
                if (chatView) chatView.style.display = 'none';
                if (chatHeader) chatHeader.style.display = 'none';
            } else if (path.startsWith('/chat/')) {
                // Chat URL - show chat view to prevent flash
                if (welcomeView) welcomeView.style.display = 'none';
                if (chatView) chatView.style.display = 'flex';
                if (chatHeader) chatHeader.style.display = 'flex';
            }
        })();
    </script>
    
    <script src="/js/chat.js"></script>
    
    <!-- Immediate button initialization for instant responsiveness -->
    <script>
        // Initialize critical UI elements immediately for instant interaction
        (function() {
            // Model dropdown button
            const modelButton = document.getElementById('mobileModelButton');
            const modelDropdown = document.querySelector('.custom-model-dropdown-menu');
            
            if (modelButton && modelDropdown) {
                modelButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = modelDropdown.classList.contains('open');
                    // Close all modals
                    document.querySelectorAll('.custom-model-dropdown-menu, .attach-menu, .main-menu-dropdown').forEach(el => {
                        el.classList.remove('open', 'show');
                    });
                    // Toggle this modal
                    if (!isOpen) {
                        modelDropdown.classList.add('open');
                    }
                });
            }
            
            // Attach button for hero view
            const heroAttachBtn = document.querySelector('.hero-input-wrapper .attach-button');
            const heroAttachMenu = document.querySelector('.hero-input-wrapper .attach-menu');
            
            if (heroAttachBtn && heroAttachMenu) {
                heroAttachBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = heroAttachMenu.classList.contains('show');
                    // Close all modals
                    document.querySelectorAll('.custom-model-dropdown-menu, .attach-menu, .main-menu-dropdown').forEach(el => {
                        el.classList.remove('open', 'show');
                    });
                    // Toggle this modal
                    if (!isOpen) {
                        heroAttachMenu.classList.add('show');
                        heroAttachBtn.classList.add('active');
                    } else {
                        heroAttachBtn.classList.remove('active');
                    }
                });
            }
            
            // Attach button for chat view
            const chatAttachBtn = document.querySelector('.chat-input-wrapper .attach-button');
            const chatAttachMenu = document.querySelector('.chat-input-wrapper .attach-menu');
            
            if (chatAttachBtn && chatAttachMenu) {
                chatAttachBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = chatAttachMenu.classList.contains('show');
                    // Close all modals
                    document.querySelectorAll('.custom-model-dropdown-menu, .attach-menu, .main-menu-dropdown').forEach(el => {
                        el.classList.remove('open', 'show');
                    });
                    // Reset attach buttons
                    document.querySelectorAll('.attach-button').forEach(btn => btn.classList.remove('active'));
                    // Toggle this modal
                    if (!isOpen) {
                        chatAttachMenu.classList.add('show');
                        chatAttachBtn.classList.add('active');
                    }
                });
            }
            
            // Main menu button - Skip this since it's handled in chat.js initMainMenu()
            // to avoid duplicate event listeners
            
            // Close modals when clicking outside
            document.addEventListener('click', function() {
                document.querySelectorAll('.custom-model-dropdown-menu, .attach-menu, .main-menu-dropdown').forEach(el => {
                    el.classList.remove('open', 'show');
                });
                document.querySelectorAll('.attach-button').forEach(btn => btn.classList.remove('active'));
            });
            
            // Prevent modal clicks from closing themselves
            document.querySelectorAll('.custom-model-dropdown-menu, .attach-menu, .main-menu-dropdown').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        })();
    </script>
    
    <!-- Initialize chat manager after chat.js loads -->
    <script type="module">
        // Initialize chat manager immediately when ready
        const initChatManager = async () => {
            console.log('Initializing chat manager...', { 
                chatApp: !!window.chatApp, 
                chatManager: !!window.chatManager 
            });
            
            if (window.chatApp && window.chatManager) {
                window.chatManager.chatApp = window.chatApp;
                
                // Check for authenticated user
                if (window.supabase) {
                    const { data: { session } } = await window.supabase.auth.getSession();
                    if (session) {
                        await window.chatManager.initialize(session.user);
                    } else {
                        // Initialize for guest user
                        await window.chatManager.initialize(null);
                    }
                } else {
                    // No Supabase, initialize for guest user
                    await window.chatManager.initialize(null);
                }
            } else {
                // If chatApp isn't ready yet, wait a bit and try again
                if (!window.chatApp) {
                    console.log('ChatApp not ready, retrying in 100ms...');
                    setTimeout(initChatManager, 100);
                }
            }
        };
        
        // Try to initialize immediately, or wait for DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initChatManager);
        } else {
            // DOM is already loaded, initialize immediately
            setTimeout(initChatManager, 0);
        }
    </script>
</body>
</html>